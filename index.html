<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UPI QR Extractor Pro</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
:root {
  --primary: #6C63FF;
  --secondary: #4CAF50;
  --danger: #ff5252;
  --info: #0ea5e9;
  --bg-gradient: linear-gradient(135deg, #0f172a, #1e293b);
  --card: rgba(255,255,255,0.05);
  --glass: rgba(255,255,255,0.08);
  --text: #ffffff;
  --input-bg: rgba(255,255,255,0.1);
}

body.light-mode {
  --bg-gradient: linear-gradient(135deg, #f1f5f9, #e2e8f0);
  --card: #ffffff;
  --glass: rgba(0,0,0,0.1);
  --text: #1e293b;
  --input-bg: #f1f5f9;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: var(--bg-gradient);
  color: var(--text);
  display: flex;
  justify-content: center;
  padding: 20px;
  min-height: 100vh;
  transition: background 0.3s, color 0.3s;
}

.container { width: 100%; max-width: 900px; }

.top-bar {
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
}

.toggle-btn {
  background: var(--card); color: var(--text); border: 1px solid var(--glass);
  padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: 0.3s;
}

h1 { text-align: center; margin-bottom: 10px; font-weight: 600; }

.tabs { display: flex; justify-content: center; margin: 20px 0; gap: 10px; flex-wrap: wrap; }

.tab-btn {
  padding: 10px 20px; border-radius: 30px; border: none; cursor: pointer;
  background: var(--glass); color: var(--text); transition: 0.3s;
}

.tab-btn.active { background: var(--primary); color: white; }

.card {
  background: var(--card); backdrop-filter: blur(12px); border-radius: 16px;
  padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center;
}

input {
  width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px;
  border: 1px solid var(--glass); background: var(--input-bg); color: var(--text); transition: 0.3s;
}

.btn-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 10px; }

button.action-btn {
  padding: 12px 18px; border-radius: 10px; border: none; cursor: pointer;
  font-weight: 500; transition: 0.3s; flex: 1; min-width: 120px;
}

.btn-primary { background: var(--primary); color: white; }
.btn-success { background: var(--secondary); color: white; }
.btn-danger { background: var(--danger); color: white; }
.btn-info { background: var(--info); color: white; }

button.action-btn:hover, .toggle-btn:hover { opacity: 0.8; }
button:disabled { opacity: 0.5; cursor: not-allowed; }

#reader { width: 100%; border-radius: 12px; overflow: hidden; margin-bottom: 15px; }
#generatedQR { margin-top: 15px; }
#generatedQR canvas { border-radius: 12px; }

.message { padding: 10px; border-radius: 8px; margin-top: 15px; display: none; text-align: center; }
.success { background: rgba(76,175,80,0.2); border: 1px solid var(--secondary); }
.error { background: rgba(255,82,82,0.2); border: 1px solid var(--danger); }

/* Context Aware Hiding */
.hidden { display: none !important; }

@media (max-width: 600px) {
  .tabs { flex-direction: column; }
  .btn-group { flex-direction: column; }
}
</style>
</head>
<body>

<div class="container">
  <div class="top-bar">
    <button class="toggle-btn" onclick="toggleTheme()" id="themeBtn">‚òÄÔ∏è Light Mode</button>
    <button class="toggle-btn" onclick="toggleLang()" id="langBtn">‡§Ö / A</button>
  </div>

<h1 id="mainTitle">UPI QR Extractor Pro</h1>

<div class="tabs">
  <button class="tab-btn active" id="tabScan" onclick="switchTab('scan', this)">Scan</button>
  <button class="tab-btn" id="tabUpload" onclick="switchTab('upload', this)">Upload</button>
  <button class="tab-btn" id="tabGenerate" onclick="switchTab('generate', this)">Generate</button>
</div>

<div id="scan" class="card tab-content">
  <div id="reader"></div>
  <div class="btn-group">
    <button class="action-btn btn-primary" id="btnStartCam" onclick="startScanner()">Start Camera</button>
    <button class="action-btn btn-danger" id="btnStopCam" onclick="stopScanner()" class="hidden">Stop Camera</button>
  </div>
</div>

<div id="upload" class="card tab-content hidden">
  <input type="file" id="qrFile" accept="image/*">
</div>

<div id="generate" class="card tab-content hidden">
  <input type="text" id="newUpiId" placeholder="UPI ID (e.g., name@bank)">
  <input type="text" id="newName" placeholder="Name (Optional)">
  <input type="number" id="newAmount" placeholder="Amount (Optional)">
  <button class="action-btn btn-primary" id="btnGenQR" onclick="generateQR()">Generate QR</button>
  
  <div id="generatedQR"></div>
  <div class="btn-group hidden" id="genActions">
    <button class="action-btn btn-success" id="btnDownload" onclick="downloadQR()">Download QR</button>
    <button class="action-btn btn-info" id="btnShareGen" onclick="shareUPI('generate')">Share QR</button>
  </div>
</div>

<div class="card hidden" id="extractedCard">
  <h3 id="extractTitle">Extracted Details</h3>
  <input type="text" id="upiId" placeholder="UPI ID" readonly>
  <input type="text" id="merchantName" placeholder="Merchant Name" readonly>
  <input type="text" id="amount" placeholder="Amount" readonly>
  
  <div class="btn-group">
    <button class="action-btn btn-primary" id="btnCopy" onclick="copyUPI()">Copy UPI ID</button>
    <button class="action-btn btn-info" id="btnShareExt" onclick="shareUPI('extract')">Share UPI ID</button>
    <button class="action-btn btn-success" id="btnPay" onclick="openUPI()">Pay Now</button>
  </div>
</div>

<div id="msg" class="message"></div>

</div>

<script>
// --- Translations & Theme ---
let currentLang = 'en';

const translations = {
  en: {
    mainTitle: "UPI QR Extractor Pro",
    tabScan: "Scan",
    tabUpload: "Upload",
    tabGenerate: "Generate",
    extractTitle: "Extracted Details",
    btnStartCam: "Start Camera",
    btnStopCam: "Stop Camera",
    btnGenQR: "Generate QR",
    btnDownload: "Download QR",
    btnShareGen: "Share QR",
    btnCopy: "Copy UPI ID",
    btnShareExt: "Share UPI ID",
    btnPay: "Pay Now"
  },
  hi: {
    mainTitle: "‡§Ø‡•Ç‡§™‡•Ä‡§Ü‡§à ‡§ï‡•ç‡§Ø‡•Ç‡§Ü‡§∞ ‡§è‡§ï‡•ç‡§∏‡§ü‡•ç‡§∞‡•à‡§ï‡•ç‡§ü‡§∞ ‡§™‡•ç‡§∞‡•ã",
    tabScan: "‡§∏‡•ç‡§ï‡•à‡§®",
    tabUpload: "‡§Ö‡§™‡§≤‡•ã‡§°",
    tabGenerate: "‡§¨‡§®‡§æ‡§è‡§Ç",
    extractTitle: "‡§®‡§ø‡§ï‡§æ‡§≤‡§æ ‡§ó‡§Ø‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£",
    btnStartCam: "‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ö‡§æ‡§≤‡•Ç ‡§ï‡§∞‡•á‡§Ç",
    btnStopCam: "‡§ï‡•à‡§Æ‡§∞‡§æ ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç",
    btnGenQR: "‡§ï‡•ç‡§Ø‡•Ç‡§Ü‡§∞ ‡§¨‡§®‡§æ‡§è‡§Ç",
    btnDownload: "‡§ï‡•ç‡§Ø‡•Ç‡§Ü‡§∞ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç",
    btnShareGen: "‡§ï‡•ç‡§Ø‡•Ç‡§Ü‡§∞ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç",
    btnCopy: "UPI ID ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç",
    btnShareExt: "UPI ID ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç",
    btnPay: "‡§Ö‡§≠‡•Ä ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç"
  }
};

function toggleLang() {
  currentLang = currentLang === 'en' ? 'hi' : 'en';
  const t = translations[currentLang];
  
  document.getElementById("mainTitle").innerText = t.mainTitle;
  document.getElementById("tabScan").innerText = t.tabScan;
  document.getElementById("tabUpload").innerText = t.tabUpload;
  document.getElementById("tabGenerate").innerText = t.tabGenerate;
  document.getElementById("extractTitle").innerText = t.extractTitle;
  document.getElementById("btnStartCam").innerText = t.btnStartCam;
  document.getElementById("btnStopCam").innerText = t.btnStopCam;
  document.getElementById("btnGenQR").innerText = t.btnGenQR;
  document.getElementById("btnDownload").innerText = t.btnDownload;
  document.getElementById("btnShareGen").innerText = t.btnShareGen;
  document.getElementById("btnCopy").innerText = t.btnCopy;
  document.getElementById("btnShareExt").innerText = t.btnShareExt;
  document.getElementById("btnPay").innerText = t.btnPay;
  
  // Update Placeholders
  document.getElementById("upiId").placeholder = currentLang === 'en' ? "UPI ID" : "‡§Ø‡•Ç‡§™‡•Ä‡§Ü‡§à ‡§Ü‡§à‡§°‡•Ä";
  document.getElementById("merchantName").placeholder = currentLang === 'en' ? "Merchant Name" : "‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ";
  document.getElementById("amount").placeholder = currentLang === 'en' ? "Amount" : "‡§∞‡§ï‡§Æ";
  document.getElementById("newUpiId").placeholder = currentLang === 'en' ? "UPI ID (e.g., name@bank)" : "‡§Ø‡•Ç‡§™‡•Ä‡§Ü‡§à ‡§Ü‡§à‡§°‡•Ä (‡§ú‡•à‡§∏‡•á, name@bank)";
  document.getElementById("newName").placeholder = currentLang === 'en' ? "Name (Optional)" : "‡§®‡§æ‡§Æ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)";
  document.getElementById("newAmount").placeholder = currentLang === 'en' ? "Amount (Optional)" : "‡§∞‡§ï‡§Æ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)";
}

function toggleTheme() {
  document.body.classList.toggle("light-mode");
  const isLight = document.body.classList.contains("light-mode");
  document.getElementById("themeBtn").innerText = isLight ? "üåô Dark Mode" : "‚òÄÔ∏è Light Mode";
}

function showMessage(text, type) {
  const msg = document.getElementById("msg");
  msg.innerText = text;
  msg.className = "message " + type;
  msg.style.display = "block";
  setTimeout(()=>msg.style.display="none", 3000);
}

// --- Context Aware Tab Switching ---
function switchTab(tabId, btnElement) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
  document.getElementById(tabId).classList.remove('hidden');
  
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  btnElement.classList.add('active');

  if (tabId === 'generate') {
    document.getElementById("extractedCard").classList.add("hidden");
    stopScanner();
  } else if (tabId === 'upload') {
    stopScanner();
  }
}

// --- Scanner Logic ---
let html5QrCode;
let isScanning = false;
let generatedBlob = null; // Store blob to fix async sharing block

function initScanner() {
  if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
}

function startScanner() {
  initScanner();
  document.getElementById("extractedCard").classList.add("hidden"); // Clear previous extraction
  
  html5QrCode.start(
    { facingMode: "environment" }, // Robust selection of rear camera
    { fps: 10, qrbox: { width: 250, height: 250 } },
    (decodedText) => {
      extractUPI(decodedText);
      stopScanner(); // Auto-stop to save battery
    },
    (errorMessage) => { /* Ignore constant scan frame errors */ }
  ).then(() => {
    isScanning = true;
    document.getElementById("btnStartCam").classList.add("hidden");
    document.getElementById("btnStopCam").classList.remove("hidden");
  }).catch(err => {
    console.error(err);
    showMessage(currentLang === 'en' ? "Camera error or permission denied." : "‡§ï‡•à‡§Æ‡§∞‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§Ø‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡•§", "error");
  });
}

async function stopScanner() {
  if (html5QrCode && isScanning) {
    try {
      await html5QrCode.stop();
      isScanning = false;
      document.getElementById("btnStartCam").classList.remove("hidden");
      document.getElementById("btnStopCam").classList.add("hidden");
    } catch(err) {
      console.error("Failed to stop scanner cleanly.", err);
    }
  }
}

// --- Data Extraction ---
function extractUPI(text) {
  if (!text.startsWith("upi://pay")) {
    showMessage(currentLang === 'en' ? "Invalid UPI QR Code" : "‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§Ø‡•Ç‡§™‡•Ä‡§Ü‡§à ‡§ï‡•ç‡§Ø‡•Ç‡§Ü‡§∞", "error");
    return;
  }
  const url = new URL(text);
  document.getElementById("upiId").value = url.searchParams.get("pa") || "";
  document.getElementById("merchantName").value = url.searchParams.get("pn") || "";
  
  let rawAmount = url.searchParams.get("am") || "";
  document.getElementById("amount").dataset.raw = rawAmount;
  document.getElementById("amount").value = rawAmount ? `‚Çπ ${rawAmount}` : "";

  document.getElementById("extractedCard").classList.remove("hidden");
  showMessage(currentLang === 'en' ? "Extracted Successfully" : "‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§®‡§ø‡§ï‡§æ‡§≤‡§æ ‡§ó‡§Ø‡§æ", "success");
}

document.getElementById("qrFile").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if(!file) return;
  document.getElementById("extractedCard").classList.add("hidden"); // Clear previous extraction
  initScanner();
  html5QrCode.scanFile(file, true)
    .then(decodedText => extractUPI(decodedText))
    .catch(() => showMessage(currentLang === 'en' ? "Cannot read QR from image" : "‡§õ‡§µ‡§ø ‡§∏‡•á ‡§ï‡•ç‡§Ø‡•Ç‡§Ü‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§™‡§¢‡§º ‡§∏‡§ï‡§§‡•á", "error"));
});

// --- Action Buttons ---
function copyUPI() {
  const upiId = document.getElementById("upiId").value;
  navigator.clipboard.writeText(upiId).then(() => {
    showMessage(currentLang === 'en' ? "UPI ID Copied!" : "UPI ID ‡§ï‡•â‡§™‡•Ä ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!", "success");
  }).catch(() => {
    showMessage(currentLang === 'en' ? "Failed to copy" : "‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤", "error");
  });
}

function openUPI() {
  const pa = document.getElementById("upiId").value;
  const pn = document.getElementById("merchantName").value;
  const am = document.getElementById("amount").dataset.raw;

  let link = `upi://pay?pa=${pa}&pn=${pn}&cu=INR`;
  if (am) link += `&am=${am}`;
  window.location.href = link;
}

// --- Context Aware Sharing ---
async function shareUPI(source) {
  if (!navigator.share) {
    showMessage(currentLang === 'en' ? "Sharing not supported." : "‡§∏‡§æ‡§ù‡§æ‡§ï‡§∞‡§£ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§", "error");
    return;
  }

  try {
    if (source === 'extract') {
      const upiId = document.getElementById("upiId").value;
      await navigator.share({
        title: "UPI ID",
        text: upiId
      });
      showMessage(currentLang === 'en' ? "Shared Successfully" : "‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ", "success");

    } else if (source === 'generate') {
      if (!generatedBlob) return;
      
      const file = new File([generatedBlob], "UPI-QR.png", { type: "image/png" });
      
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({
          title: 'Scan to Pay',
          files: [file]
        });
      } else {
        const fallbackLink = document.getElementById("newUpiId").value;
        await navigator.share({ title: 'UPI ID', text: fallbackLink });
      }
      showMessage(currentLang === 'en' ? "Shared Successfully" : "‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ", "success");
    }
  } catch (err) {
    console.error(err);
  }
}

// --- Generation ---
function generateQR() {
  const pa = document.getElementById("newUpiId").value.trim().toLowerCase(); // Sanitized
  const pn = document.getElementById("newName").value.trim();
  const am = document.getElementById("newAmount").value.trim();
  
  if (!pa || !pa.includes('@')) { 
    showMessage(currentLang === 'en' ? "Please enter a valid UPI ID" : "‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§Ø‡•Ç‡§™‡•Ä‡§Ü‡§à ‡§Ü‡§à‡§°‡•Ä ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç", "error"); 
    return; 
  }

  let upiString = `upi://pay?pa=${pa}&pn=${pn}&cu=INR`;
  if (am) upiString += `&am=${am}`;

  document.getElementById("generatedQR").innerHTML = "";

  QRCode.toCanvas(upiString, { width: 220, margin: 2 }, function (err, canvas) {
    if(err) return;
    document.getElementById("generatedQR").appendChild(canvas);
    document.getElementById("genActions").classList.remove("hidden");
    
    // Pre-generate blob for synchronous sharing later
    canvas.toBlob((blob) => {
        generatedBlob = blob;
    }, "image/png");
  });
  
  showMessage(currentLang === 'en' ? "QR Generated!" : "‡§ï‡•ç‡§Ø‡•Ç‡§Ü‡§∞ ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ!", "success");
}

function downloadQR() {
  const canvas = document.querySelector("#generatedQR canvas");
  if (!canvas) return;
  const link = document.createElement('a');
  link.href = canvas.toDataURL("image/png");
  link.download = 'My-UPI-QR.png';
  link.click();
}
</script>

</body>
</html>
